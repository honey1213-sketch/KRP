<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuber Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- CLEAN UI STYLES --- */
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif;
            background-color: #d1d7db; height: 100vh; display: flex; justify-content: center; align-items: center;
        }

        /* App Container */
        #app {
            width: 100%; height: 100%; max-width: 1600px; background: white; display: flex;
            position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Screens --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
        }
        .screen.active { display: flex; }

        /* Login Screen */
        #login-screen {
            background-color: #fff; justify-content: center; align-items: center;
        }
        .login-box {
            width: 350px; text-align: center; padding: 40px; border: 1px solid #ddd; border-radius: 8px;
        }
        .input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
        }
        .btn {
            width: 100%; padding: 12px; background: #00a884; color: white; border: none;
            border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold;
        }
        .btn:hover { background: #008f72; }
        .link { color: #00a884; cursor: pointer; margin-top: 15px; display: block; }

        /* Setup Username Modal */
        #setup-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center;
        }

        /* --- Main Layout --- */
        /* Sidebar */
        .sidebar {
            width: 30%; min-width: 300px; max-width: 450px; border-right: 1px solid #e9edef;
            display: flex; flex-direction: column; background: #fff;
        }
        .header {
            height: 60px; background: #f0f2f5; padding: 10px 16px; display: flex;
            align-items: center; justify-content: space-between; border-bottom: 1px solid #e9edef;
        }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        
        .add-contact-box { display: none; padding: 10px; background: #f0f2f5; border-bottom: 1px solid #e9edef; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; padding: 12px 15px; border-bottom: 1px solid #f0f2f5;
            cursor: pointer; align-items: center;
        }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item img { width: 49px; height: 49px; border-radius: 50%; margin-right: 15px; }
        .chat-info h4 { margin: 0; font-size: 16px; font-weight: 400; }
        .tick { color: #34b7f1; font-size: 12px; margin-left: 4px; display: none; }
        .tick.show { display: inline-block; }

        /* Chat Area */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: #efeae2;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            position: relative;
        }
        .chat-header {
            height: 60px; background: #f0f2f5; padding: 10px 16px; display: flex;
            align-items: center; border-bottom: 1px solid #e9edef;
        }
        .messages { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        
        .bubble {
            max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px;
            font-size: 14px; position: relative; word-wrap: break-word;
        }
        .bubble.in { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .bubble.out { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        .time { float: right; font-size: 10px; color: #999; margin-left: 10px; margin-top: 5px; }

        .footer {
            height: 62px; background: #f0f2f5; padding: 5px 16px; display: flex; align-items: center;
        }
        .msg-input { flex: 1; padding: 9px 12px; border: none; border-radius: 8px; outline: none; }

        /* Admin Panel */
        #admin-panel {
            padding: 20px; background: #f2f2f7; overflow-y: auto; display: none; width: 100%;
        }
        .req-card {
            background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;
            border: 1px solid #ddd;
        }
        .btn-green { background: #25d366; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-red { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* Mobile */
        @media(max-width: 768px) {
            .sidebar { width: 100%; z-index: 2; position: absolute; height: 100%; }
            .chat-area { width: 100%; position: absolute; height: 100%; z-index: 1; }
            .sidebar.show { display: flex; }
            .sidebar.hide { display: none; }
        }
    </style>
</head>
<body>

<div id="app">

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen" class="screen active">
        <div class="login-box">
            <h2 style="color: #00a884;">Zuber Chat</h2>
            <input type="email" id="login-email" class="input" placeholder="Email">
            <input type="password" id="login-pass" class="input" placeholder="Password">
            <button class="btn" id="btn-login">Login</button>
            <span class="link" id="btn-signup">Create Account</span>
            
            <div id="signup-box" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <input type="email" id="signup-email" class="input" placeholder="New Email">
                <input type="password" id="signup-pass" class="input" placeholder="New Password">
                <button class="btn" id="btn-create">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- 2. SETUP MODAL -->
    <div id="setup-modal">
        <div class="modal-content">
            <h3>Welcome!</h3>
            <p>Create your username</p>
            <input type="text" id="setup-username" class="input">
            <button class="btn" id="btn-setup-save">Start</button>
        </div>
    </div>

    <!-- 3. ADMIN PANEL (Only for 'zuber') -->
    <div id="admin-panel" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Admin Dashboard</h2>
            <button class="btn" id="btn-admin-logout" style="width:100px;">Logout</button>
        </div>
        <div id="requests-list"></div>
    </div>

    <!-- 4. NORMAL CHAT APP -->
    <div id="chat-screen" class="screen">
        <div class="sidebar" id="sidebar">
            <div class="header">
                <img id="my-avatar" class="avatar">
                <div style="display:flex; gap:20px;">
                    <i class="ri-user-add-line" style="cursor:pointer;" id="btn-add-contact"></i>
                    <i class="ri-logout-box-r-line" style="cursor:pointer;" id="btn-logout"></i>
                </div>
            </div>
            <div class="add-contact-box" id="add-contact-box">
                <input type="text" id="search-user" class="input" placeholder="Search username...">
            </div>
            <div class="chat-list" id="chat-list"></div>
        </div>

        <div class="chat-area" id="chat-area">
            <div style="display:flex; height:100%; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <i class="ri-chat-smile-2-line" style="font-size:50px; color:#999;"></i>
                <h2>Zuber Web</h2>
                <p>Secure Chat App</p>
            </div>
        </div>

        <!-- Active Chat View -->
        <div class="chat-area" id="active-chat-view" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;">
            <div class="chat-header">
                <i class="ri-arrow-left-line" style="font-size:24px; margin-right:15px; cursor:pointer;" id="btn-back"></i>
                <img id="chat-header-img" class="avatar" style="width:35px; height:35px;">
                <div>
                    <h4 id="chat-header-name" style="margin:0;">User</h4>
                    <span style="font-size:12px; color:#666;">Online</span>
                </div>
            </div>
            <div class="messages" id="msg-box"></div>
            <div class="footer">
                <input type="text" class="msg-input" id="msg-input" placeholder="Type message...">
                <button class="btn-green" id="btn-send" style="width:50px; border-radius:50%; margin-left:10px;"><i class="ri-send-plane-fill"></i></button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, push, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyChKPlzj9uVm3KBi4iPOz8xQHtC6v0Lt4E",
        authDomain: "krp-bank.firebaseapp.com",
        databaseURL: "https://krp-bank-default-rtdb.firebaseio.com",
        projectId: "krp-bank",
        storageBucket: "krp-bank.firebasestorage.app",
        messagingSenderId: "911407082396",
        appId: "1:911407082396:web:c5af104a844e2697797659",
        measurementId: "G-R0J2TLLC3T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // --- HELPER FUNCTIONS ---
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    
    // --- AUTHENTICATION ---
    let currentUser = null;
    let currentUsername = null;

    document.getElementById('btn-signup').onclick = () => document.getElementById('signup-box').style.display = 'block';
    
    document.getElementById('btn-login').onclick = () => {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-pass').value;
        signInWithEmailAndPassword(auth, e, p)
            .then(() => alert("Login Successful!"))
            .catch(err => alert("Error: " + err.message));
    };

    document.getElementById('btn-create').onclick = () => {
        const e = document.getElementById('signup-email').value;
        const p = document.getElementById('signup-pass').value;
        createUserWithEmailAndPassword(auth, e, p)
            .then(() => alert("Account Created!"))
            .catch(err => alert("Error: " + err.message));
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => window.location.reload());
    document.getElementById('btn-admin-logout').onclick = () => signOut(auth).then(() => window.location.reload());

    onAuthStateChanged(auth, (user) => {
        if(user) {
            currentUser = user;
            checkUser(user.uid);
        } else {
            showScreen('login-screen');
        }
    });

    // --- USERNAME LOGIC ---
    function checkUser(uid) {
        get(ref(db, 'users/' + uid)).then(snap => {
            if(snap.exists()) {
                const data = snap.val();
                currentUsername = data.username;
                if(currentUsername === 'zuber') {
                    initAdmin();
                } else {
                    initChat(data);
                }
            } else {
                document.getElementById('setup-modal').style.display = 'flex';
            }
        });
    }

    document.getElementById('btn-setup-save').onclick = () => {
        const u = document.getElementById('setup-username').value.trim();
        if(u.length < 3) return alert("Too short");
        
        // Check taken
        get(ref(db, 'usernames/' + u)).then(snap => {
            if(snap.exists()) return alert("Username taken");
            
            // Save
            set(ref(db, 'usernames/' + u), currentUser.uid);
            set(ref(db, 'users/' + currentUser.uid), {
                username: u, email: currentUser.email, verified: false, uid: currentUser.uid
            }).then(() => {
                currentUsername = u;
                document.getElementById('setup-modal').style.display = 'none';
                checkUser(currentUser.uid);
            });
        });
    };

    // --- ADMIN PANEL ---
    function initAdmin() {
        showScreen('admin-panel');
        document.getElementById('requests-list').innerHTML = '';
        
        onValue(ref(db, 'requests'), snap => {
            const list = document.getElementById('requests-list');
            list.innerHTML = "";
            if(!snap.exists()) { list.innerHTML = "<p>No requests</p>"; return; }
            
            snap.forEach(child => {
                const r = child.val();
                const div = document.createElement('div');
                div.className = 'req-card';
                div.innerHTML = `
                    <p><b>Username:</b> ${r.username}</p>
                    <p><b>Name:</b> ${r.realName}</p>
                    <p><b>Profession:</b> ${r.profession}</p>
                    <img src="${r.docUrl}" style="width:100px; height:100px; object-fit:cover;">
                    <br><br>
                    <button class="btn-green" onclick="accept('${child.key}', '${r.username}')">Accept</button>
                    <button class="btn-red" onclick="reject('${child.key}')">Reject</button>
                `;
                list.appendChild(div);
            });
        });
    }

    window.accept = async (uid, name) => {
        if(!confirm("Verify " + name + "?")) return;
        await update(ref(db, 'users/' + uid), { verified: true });
        
        // Send Msg
        const chatId = [currentUser.uid, uid].sort().join('_');
        await push(ref(db, 'chats/' + chatId), {
            sender: currentUser.uid, text: "Congrats! You are now verified (Blue Tick).", timestamp: Date.now()
        });
        
        await remove(ref(db, 'requests/' + uid));
        alert("Verified and Sent Message");
    };

    window.reject = async (uid) => {
        if(!confirm("Reject?")) return;
        await remove(ref(db, 'requests/' + uid));
    };

    // --- NORMAL CHAT APP ---
    function initChat(data) {
        showScreen('chat-screen');
        document.getElementById('my-avatar').src = `https://ui-avatars.com/api/?name=${currentUsername}&background=random`;
        loadContacts();
        
        // Verification Request Handler
        document.getElementById('my-avatar').onclick = () => {
            if(!data.verified) {
                const name = prompt("Real Name for Verification:");
                const prof = prompt("Profession:");
                if(!name || !prof) return;
                
                alert("Please upload ID proof logic requires file input. For now, auto-sending request with placeholder.");
                set(ref(db, 'requests/' + currentUser.uid), {
                    username: currentUsername, realName: name, profession: prof, docUrl: "https://via.placeholder.com/150"
                }).then(() => alert("Request Sent to Admin 'zuber'"));
            }
        };
    }

    document.getElementById('btn-add-contact').onclick = () => {
        const box = document.getElementById('add-contact-box');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
    };

    document.getElementById('search-user').onkeypress = (e) => {
        if(e.key === 'Enter') {
            const u = document.getElementById('search-user').value.trim().toLowerCase();
            get(ref(db, 'usernames/' + u)).then(snap => {
                if(snap.exists()) {
                    const fid = snap.val();
                    if(fid === currentUser.uid) return alert("Can't add self");
                    set(ref(db, 'users/' + currentUser.uid + '/contacts/' + fid), {
                        username: u, timestamp: Date.now()
                    }).then(() => {
                        document.getElementById('search-user').value = '';
                        document.getElementById('add-contact-box').style.display = 'none';
                        alert("Contact Added");
                    });
                } else {
                    alert("User not found");
                }
            });
        }
    };

    function loadContacts() {
        onValue(ref(db, 'users/' + currentUser.uid + '/contacts'), snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            const c = [];
            snap.forEach(child => c.push({uid: child.key, ...child.val()}));
            c.sort((a,b) => b.timestamp - a.timestamp);

            c.forEach(contact => {
                get(ref(db, 'users/' + contact.uid)).then(uSnap => {
                    const isVerified = uSnap.exists() && uSnap.val().verified;
                    const tick = isVerified ? '<span class="tick show">âœ…</span>' : '';
                    
                    const div = document.createElement('div');
                    div.className = 'chat-item';
                    div.onclick = () => openChat(contact.uid, contact.username);
                    div.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${contact.username}&background=random">
                        <div class="chat-info">
                            <h4>${contact.username} ${tick}</h4>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        });
    }

    let currentChatId = null;
    function openChat(uid, name) {
        currentChatId = [currentUser.uid, uid].sort().join('_');
        document.getElementById('active-chat-view').style.display = 'flex';
        document.getElementById('chat-header-name').innerText = name;
        document.getElementById('chat-header-img').src = `https://ui-avatars.com/api/?name=${name}&background=random`;
        
        // Mobile Nav Logic (Simple)
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').style.display = 'none';
        }

        loadMessages();
    }

    document.getElementById('btn-back').onclick = () => {
        document.getElementById('active-chat-view').style.display = 'none';
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').style.display = 'flex';
        }
    };

    function loadMessages() {
        onValue(ref(db, 'chats/' + currentChatId), snap => {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            const m = [];
            snap.forEach(child => m.push(child.val()));
            m.sort((a,b) => a.timestamp - b.timestamp);

            m.forEach(msg => {
                const div = document.createElement('div');
                div.className = `bubble ${msg.sender === currentUser.uid ? 'out' : 'in'}`;
                const t = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                div.innerHTML = `${msg.text} <span class="time">${t}</span>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    const input = document.getElementById('msg-input');
    document.getElementById('btn-send').onclick = () => {
        const t = input.value.trim();
        if(!t) return;
        push(ref(db, 'chats/' + currentChatId), {
            sender: currentUser.uid, text: t, timestamp: Date.now()
        });
        input.value = "";
    };
    input.onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('btn-send').click(); };

</script>
</body>
</html>
