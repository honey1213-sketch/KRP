<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuber - Social App</title>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #fafafa;
            --white: #ffffff;
            --border: #dbdbdb;
            --text-main: #262626;
            --text-light: #8e8e8e;
            --primary: #0095f6;
            --button-blue: #0095f6;
            --story-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; overflow-x: hidden; }

        /* --- Screens Logic --- */
        .screen { display: none; width: 100%; height: 100%; }
        .screen.active { display: flex; flex-direction: column; }

        /* --- Auth & Setup Screen --- */
        .auth-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            border: 1px solid var(--border);
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 350px;
            margin-bottom: 10px;
        }

        .app-logo { font-family: 'Billabong', cursive; font-size: 3rem; margin-bottom: 20px; display: block; }
        .app-logo span { background: linear-gradient(45deg, #f09433, #bc1888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 9px 8px;
            border: 1px solid var(--border);
            border-radius: 3px;
            margin-bottom: 10px;
            background: #fafafa;
            outline: none;
        }

        .btn-google {
            background-color: var(--button-blue);
            color: white;
            border: none;
            padding: 7px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* --- Main App Layout --- */
        nav {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-content {
            width: 100%;
            max-width: 630px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .nav-icons i { font-size: 1.5rem; margin-left: 20px; cursor: pointer; }

        /* --- Feed --- */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            padding-top: 30px;
            overflow-y: auto;
        }

        .feed-container {
            width: 100%;
            max-width: 470px;
            padding-bottom: 60px;
        }

        /* Stories */
        .stories-wrapper {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 0;
            margin-bottom: 20px;
            overflow-x: auto;
            display: flex;
            gap: 15px;
            padding-left: 15px;
            scrollbar-width: none; /* Hide scrollbar */
        }
        .stories-wrapper::-webkit-scrollbar { display: none; }

        .story {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            min-width: 66px;
        }
        
        .story-ring {
            width: 66px;
            height: 66px;
            border-radius: 50%;
            padding: 2px;
            background: var(--story-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .story-ring img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--white);
            object-fit: cover;
        }

        .story-username { font-size: 0.75rem; margin-top: 5px; color: var(--text-main); }

        /* Post Card */
        .post-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .post-header {
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .post-user { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; }
        .post-user img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        .post-image { width: 100%; display: block; min-height: 300px; background: #efefef; object-fit: cover; }

        .post-actions { padding: 10px 14px; font-size: 1.5rem; display: flex; gap: 15px; }
        .post-actions i { cursor: pointer; transition: transform 0.1s; }
        .post-actions i:active { transform: scale(0.9); }
        .post-actions i.liked { color: #ed4956; }

        .post-likes { padding: 0 14px; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        .post-caption { padding: 0 14px 14px 14px; font-size: 0.9rem; }
        .post-caption span { font-weight: 600; margin-right: 5px; }

        /* --- Create Post Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.65);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active { display: flex; }

        .modal-content {
            background: var(--white);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            font-weight: 600;
            position: relative;
        }

        .close-modal { position: absolute; right: 15px; top: 12px; cursor: pointer; color: var(--primary); font-weight: bold; }

        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .preview-img { width: 100%; height: 200px; object-fit: contain; background: #fafafa; border: 1px solid var(--border); display: none; }

        .upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .nav-content { padding: 0 10px; }
            .app-logo { font-size: 2rem; }
            .feed-container { max-width: 100%; padding: 0; border: none; }
            .post-card { border-radius: 0; border-left: none; border-right: none; }
            .stories-wrapper { border: none; border-radius: 0; margin-bottom: 10px; background: transparent; }
        }
    </style>
</head>
<body>

    <!-- 1. Login Screen -->
    <div id="authScreen" class="screen active">
        <div class="auth-container">
            <div class="login-box">
                <h1 class="app-logo"><span>Zuber</span></h1>
                <p style="color:var(--text-light); margin-bottom:20px;">Sign in to see photos and videos from your friends.</p>
                <button class="btn-google" id="googleLoginBtn">
                    <i class="ri-google-fill"></i> Log in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Username Setup Screen -->
    <div id="setupScreen" class="screen">
        <div class="auth-container">
            <div class="login-box">
                <img id="setupProfilePic" src="" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
                <h2>Welcome to Zuber</h2>
                <p style="margin-bottom:20px;">Please choose a username to continue.</p>
                <input type="text" id="usernameInput" placeholder="Create a username">
                <button class="btn-google" id="saveUsernameBtn" style="margin-top:10px;">Continue</button>
            </div>
        </div>
    </div>

    <!-- 3. Main App Screen -->
    <div id="appScreen" class="screen">
        <nav>
            <div class="nav-content">
                <h1 class="app-logo" style="margin:0; font-size: 1.8rem;"><span>Zuber</span></h1>
                <div class="nav-icons">
                    <i class="ri-home-5-fill"></i>
                    <i class="ri-messenger-line"></i>
                    <i class="ri-add-circle-line" id="openCreatePostBtn"></i>
                    <i class="ri-compass-3-line"></i>
                    <img id="navProfilePic" src="" style="width:24px; height:24px; border-radius:50%; cursor:pointer; margin-left:20px;">
                </div>
            </div>
        </nav>

        <div class="main-content">
            <div class="feed-container">
                
                <!-- Stories -->
                <div class="stories-wrapper">
                    <!-- Dynamic Stories will load here -->
                    <div class="story">
                        <div class="story-ring"><img src="https://picsum.photos/seed/my/100/100"></div>
                        <span class="story-username">Your Story</span>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="feedList">
                    <!-- Posts will load here -->
                    <div style="text-align:center; padding:40px; color:#8e8e8e;">Loading feed...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Create new post
                <span class="close-modal" id="closeModalBtn">Cancel</span>
            </div>
            <div class="modal-body">
                <input type="file" id="postFileInput" accept="image/*">
                <img id="postPreview" class="preview-img">
                <input type="text" id="postCaption" placeholder="Write a caption...">
                <button class="upload-btn" id="sharePostBtn">Share</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (Module Type) -->
    <script type="module">
        // Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your web app's Firebase configuration (Provided by User)
        const firebaseConfig = {
            apiKey: "AIzaSyChKPlzj9uVm3KBi4iPOz8xQHtC6v0Lt4E",
            authDomain: "krp-bank.firebaseapp.com",
            databaseURL: "https://krp-bank-default-rtdb.firebaseio.com",
            projectId: "krp-bank",
            storageBucket: "krp-bank.firebasestorage.app",
            messagingSenderId: "911407082396",
            appId: "1:911407082396:web:c5af104a844e2697797659",
            measurementId: "G-R0J2TLLC3T"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const authScreen = document.getElementById('authScreen');
        const setupScreen = document.getElementById('setupScreen');
        const appScreen = document.getElementById('appScreen');
        const feedList = document.getElementById('feedList');
        
        // Auth Elements
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const usernameInput = document.getElementById('usernameInput');
        const saveUsernameBtn = document.getElementById('saveUsernameBtn');
        const setupProfilePic = document.getElementById('setupProfilePic');
        const navProfilePic = document.getElementById('navProfilePic');

        // Post Elements
        const openCreatePostBtn = document.getElementById('openCreatePostBtn');
        const createPostModal = document.getElementById('createPostModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const postFileInput = document.getElementById('postFileInput');
        const postPreview = document.getElementById('postPreview');
        const postCaption = document.getElementById('postCaption');
        const sharePostBtn = document.getElementById('sharePostBtn');

        // --- Global State ---
        let currentUser = null;
        let currentUsername = null;

        // --- Authentication Logic ---
        
        // 1. Google Login
        googleLoginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    // User signed in, handled by onAuthStateChanged
                }).catch((error) => {
                    alert(error.message);
                });
        });

        // 2. Listen for Auth Changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupProfilePic.src = user.photoURL;
                // Check if user has username in DB
                checkUsernameExists(user.uid);
            } else {
                showScreen('authScreen');
                currentUser = null;
            }
        });

        // 3. Check Username in DB
        function checkUsernameExists(uid) {
            const userRef = ref(db, 'users/' + uid);
            get(userRef).then((snapshot) => {
                if (snapshot.exists()) {
                    currentUsername = snapshot.val().username;
                    navProfilePic.src = currentUser.photoURL;
                    showScreen('appScreen');
                    loadFeed();
                    loadStories();
                } else {
                    showScreen('setupScreen');
                }
            });
        }

        // 4. Save Username
        saveUsernameBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username.length < 3) {
                alert("Username must be at least 3 characters");
                return;
            }
            
            set(ref(db, 'users/' + currentUser.uid), {
                username: username,
                email: currentUser.email,
                profilePic: currentUser.photoURL
            }).then(() => {
                currentUsername = username;
                navProfilePic.src = currentUser.photoURL;
                showScreen('appScreen');
                loadFeed();
                loadStories();
            });
        });

        // --- UI Helpers ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // --- Feed & Posts Logic ---

        function loadFeed() {
            const postsRef = ref(db, 'posts');
            onValue(postsRef, (snapshot) => {
                feedList.innerHTML = "";
                const posts = [];
                
                snapshot.forEach((childSnapshot) => {
                    posts.push(childSnapshot.val());
                });

                // Reverse to show newest first
                posts.reverse().forEach(post => {
                    createPostElement(post);
                });
            });
        }

        function createPostElement(post) {
            const isLiked = post.likes && post.likes[currentUser.uid];
            const likeClass = isLiked ? 'ri-heart-3-fill liked' : 'ri-heart-3-line';
            const likesCount = post.likes ? Object.keys(post.likes).length : 0;

            const div = document.createElement('div');
            div.className = 'post-card';
            div.innerHTML = `
                <div class="post-header">
                    <div class="post-user">
                        <img src="${post.userProfilePic || 'https://picsum.photos/50'}" alt="User">
                        <span>${post.username}</span>
                    </div>
                    <i class="ri-more-fill" style="cursor:pointer;"></i>
                </div>
                <img src="${post.imageUrl}" class="post-image" ondblclick="handleLike('${post.postId}')">
                <div class="post-actions">
                    <i class="${likeClass}" id="likeBtn-${post.postId}" onclick="handleLike('${post.postId}')"></i>
                    <i class="ri-chat-3-line"></i>
                    <i class="ri-send-plane-fill"></i>
                    <i class="ri-bookmark-line" style="margin-left:auto;"></i>
                </div>
                <div class="post-likes" id="likesCount-${post.postId}">${likesCount} likes</div>
                <div class="post-caption">
                    <span>${post.username}</span> ${post.caption}
                </div>
            `;
            feedList.appendChild(div);
        }

        // --- Likes Logic ---
        window.handleLike = function(postId) {
            const postRef = ref(db, 'posts/' + postId + '/likes/' + currentUser.uid);
            get(postRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // Unlike
                    set(postRef, null);
                } else {
                    // Like
                    set(postRef, true);
                }
            });
        }
        
        // Expose function globally for HTML onclick
        window.handleLike = handleLike;

        // Listen for realtime like updates to update UI immediately without re-rendering whole list
        // (Optimization: In a bigger app we'd bind individual listeners, here we re-render for simplicity or just handle click visual)
        // For this demo, let's keep it simple: The `onValue` in loadFeed already handles re-rendering.
        // But to make it smoother, we could just toggle the class visually and let DB sync in background.

        // --- Stories Logic ---
        function loadStories() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const storiesWrapper = document.querySelector('.stories-wrapper');
                // Keep the "Your Story" element
                storiesWrapper.innerHTML = `
                    <div class="story">
                        <div class="story-ring"><img src="${currentUser.photoURL}"></div>
                        <span class="story-username">Your Story</span>
                    </div>
                `;
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    // Don't show self in stories list
                    if(user.username !== currentUsername) {
                        const div = document.createElement('div');
                        div.className = 'story';
                        div.innerHTML = `
                            <div class="story-ring"><img src="${user.profilePic}"></div>
                            <span class="story-username">${user.username}</span>
                        `;
                        storiesWrapper.appendChild(div);
                    }
                });
            });
        }

        // --- Create Post Logic ---
        openCreatePostBtn.addEventListener('click', () => {
            createPostModal.classList.add('active');
        });

        closeModalBtn.addEventListener('click', () => {
            createPostModal.classList.remove('active');
            resetCreateForm();
        });

        postFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                postPreview.src = URL.createObjectURL(file);
                postPreview.style.display = 'block';
            }
        });

        sharePostBtn.addEventListener('click', async () => {
            const file = postFileInput.files[0];
            const caption = postCaption.value;

            if (!file && !caption) return;

            const postId = push(ref(db, 'posts')).key;
            let imageUrl = `https://picsum.photos/seed/${postId}/600/600`; // Default placeholder

            sharePostBtn.innerText = "Sharing...";

            // Try to upload image
            if (file) {
                try {
                    const storageRef = sRef(storage, 'posts/' + postId);
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                } catch (error) {
                    console.warn("Upload failed (Check Storage Rules), using placeholder.", error);
                    alert("Image upload failed (Check Firebase Console Rules). Using placeholder image instead.");
                    // imageUrl remains the placeholder url defined above
                }
            }

            // Save Post Data to Database
            set(ref(db, 'posts/' + postId), {
                postId: postId,
                uid: currentUser.uid,
                username: currentUsername,
                userProfilePic: currentUser.photoURL,
                imageUrl: imageUrl,
                caption: caption,
                timestamp: Date.now()
            }).then(() => {
                createPostModal.classList.remove('active');
                resetCreateForm();
                sharePostBtn.innerText = "Share";
            });
        });

        function resetCreateForm() {
            postFileInput.value = '';
            postCaption.value = '';
            postPreview.style.display = 'none';
            postPreview.src = '';
        }

    </script>
</body>
</html>
